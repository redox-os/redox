#!/usr/bin/env bash
# Redox VM Serial Console Connector
# Provides interactive serial console access to Redox VMs

set -e

pty_socket="$1"

if [[ -z "$pty_socket" ]]; then
    echo "Usage: $0 <pty-socket-path>"
    exit 1
fi

if [[ ! -S "$pty_socket" ]]; then
    echo "Error: Socket not found: $pty_socket"
    exit 1
fi

# Save terminal settings
saved_settings=$(stty -g)

# Restore terminal on exit
cleanup() {
    stty "$saved_settings" 2>/dev/null || true
    echo ""
    echo "Disconnected from Redox VM"
}
trap cleanup EXIT INT TERM

# Set raw terminal mode for proper interaction
# -echo: don't echo input (VM does this)
# -icanon: disable canonical mode (no line buffering)
# -isig: disable interrupt signals
# min 1: read at least 1 character
# time 0: no timeout
stty raw -echo -icanon -isig min 1 time 0 2>/dev/null

# Set terminal size for proper display
if command -v resize >/dev/null 2>&1; then
    eval "$(resize)"
fi

# Export TERM for better compatibility
export TERM=vt100

# Use nc to connect to UNIX socket
# This provides bidirectional communication with the VM serial console
nc -U "$pty_socket"
