[source]
same_as = "../os-test"

[build]
template = "custom"
dev-dependencies = [
    "host:redoxer",
    "gnu-grep",
    "gnu-make",
    "libarchive",
    "sed",
]
script = """
rsync -a "${COOKBOOK_SOURCE}/" ./
case "$(echo "${TARGET}" | cut -d - -f3)" in
    linux)  OS=Linux;;
    redox)  OS=Redox;;
esac

make OS=${OS} CC="${CC}" CFLAGS= CPPFLAGS= \
        LDFLAGS= EXTRA_LDFLAGS= \
        CC_FOR_BUILD="${CC_WRAPPER} cc" CFLAGS_FOR_BUILD= CPPFLAGS_FOR_BUILD= \
        LDFLAGS_FOR_BUILD= all

skips=(
    # Skip fputc_unlocked, hanging on Linux with relibc
    basic/stdio/putc_unlocked
)
for skip in "${skips[@]}"
do
    mkdir -p out.known/{linux,redox}/"$(dirname "${skip}")"
    echo "skipped" > out.known/linux/"${skip}.out"
    echo "skipped" > out.known/redox/"${skip}.out"
done
cp -t out -R out.known/linux
cp -t out -R out.known/redox

if [ "$TARGET" = "$COOKBOOK_HOST_TARGET" ]; then
    make test
else
    redoxer exec --folder . --folder ${COOKBOOK_SYSROOT}/usr/:/usr --artifact . make test
fi

make html json jsonl

mkdir -p ${COOKBOOK_STAGE}/share/os-test
mv html ${COOKBOOK_STAGE}/share/os-test/html
mv out ${COOKBOOK_STAGE}/share/os-test/out
mv os-test.json ${COOKBOOK_STAGE}/share/os-test/os-test.json
"""
